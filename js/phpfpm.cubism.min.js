(function(m){var b=m.phpfpm={};b.url=function(b){this.url=b;this.addQueryString=function(c,a){var f=RegExp("([?|&])"+c+"=.*?(&|#|$)(.*)","gi");f.test(this.url)?this.url=this.url.replace(f,"$1"+c+(a?"="+a:"")+"$2$3"):(f=this.url.split("#"),this.url=f[0]+(-1!==this.url.indexOf("?")?"&":"?")+c,a&&(this.url+="="+a),f[1]&&(this.url+="#"+f[1]));return this};this.toString=function(){return this.url};return this};b.status=function(g,c){this.url=b.url(g).addQueryString("json").toString();this.delay=c;this.data=
{};this.previousData={};this.backupOnError={};this.lastFetch=null;this.fetchNumber=0;this.fetchInProgress=!1;this.error=this.callback=null;this.fetch=function(){if(!this.fetchInProgress){this.lastFetch=+new Date;this.fetchNumber++;this.fetchInProgress=!0;var a=this;d3.json(this.url,function(f,d){f?(a.error=f,a.backupOnError=a.previousData,a.previousData={},a.data={}):(a.error?(a.error=null,a.previousData=a.backupOnError,a.backupOnError={}):a.previousData=a.data,a.previousData["accepted conn"]&&d["accepted conn"]<
a.previousData["accepted conn"]&&(a.fetchNumber=1),a.data=d,a.data["accepted conn"]-=a.fetchNumber,a.callback&&a.callback(a));a.fetchInProgress=!1})}return this};this.get=function(){var a=+new Date;(!this.lastFetch||this.lastFetch+this.delay<a)&&this.fetch();return this.data};this.getPrevious=function(){return this.previousData};return this};b.monitoring=function(g,c,a){this.start=+new Date;this.status=b.status(g,c);this.context=cubism.context().serverDelay(0).clientDelay(0).step(c).size(a).on("focus",
function(f){d3.selectAll(".value").style("right",null==f?null:a-f+"px")});this.getMetric=function(a,d){var l=this;return this.context.metric(function(e,k,d,c){var h=[];e=+e;if(e>=l.start)for(k=+k;e<k;){e+=d;var b=l.status.get()[a];b&&h.push(b)}c(null,h)},d?d:a)};this.getDiffMetric=function(a,d){var b=this;return this.context.metric(function(e,d,c,n){var h=[];e=+e;if(e>=b.start)for(d=+d;e<d;){e+=c;var g=b.status.get()[a]-b.status.getPrevious()[a];g&&h.push(g)}n(null,h)},d)};this.getData=function(){return[this.getMetric("accepted conn",
"total conn"),this.getDiffMetric("accepted conn","new conn"),this.getMetric("active processes"),this.getDiffMetric("active processes","~ active processes"),this.getMetric("idle processes"),this.getDiffMetric("idle processes","~ idle processes"),this.getMetric("total processes"),this.getDiffMetric("total processes","~ total processes"),this.getMetric("max active processes"),this.getMetric("max children reached"),this.getMetric("listen queue"),this.getDiffMetric("listen queue","~ listen queue"),this.getMetric("max listen queue")]};
this.display=function(a,d){this.start=+new Date;if(a=d3.select(a)){var b="phpfpm";d&&(b+=" "+d);a.attr("class",b);var e=a.append("h1").attr("class","title");this.status.callback=function(a){e.text("Pool "+a.data.pool+" ("+a.data["process manager"]+") started since "+new Date(1E3*a.data["start time"]))};this.status.fetch();var c=a.append("div").attr("class","graphe"),g=this;c.call(function(a){c.append("div").attr("class","axis").call(g.context.axis().orient("top"));c.selectAll(".horizon").data(g.getData()).enter().append("div").attr("class",
function(a){return"horizon "+a.toString().replace(/\s+/g,"")}).call(function(a){return a=g.context.horizon().format(d3.format("d")).colors("#0d58f1 #568bf5 #9fbdfa #e8effe #feefe8 #fabd9f #f58b56 #f1580d".split(" "))(a)});c.append("div").attr("class","rule").call(g.context.rule())})}return this};return this}})(cubism);
